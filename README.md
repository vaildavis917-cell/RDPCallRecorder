# RDP Call Recorder

> **[English version](README_EN.md)**

**Агент автоматической записи звонков в RDP-сессиях.** Записывает звонки WhatsApp, Telegram и Viber с голосами обоих собеседников в один аудиофайл.

![RDP Call Recorder](src/app.ico)

## Как это работает

Приложение использует гибридный подход для обнаружения и записи звонков, чтобы обеспечить максимальную точность и минимизировать ложные срабатывания (например, от звуков уведомлений).

### 1. Мониторинг процессов

- **Основной цикл:** Каждые 2 секунды (настраивается в `config.ini`) агент сканирует список запущенных процессов.
- **Целевые процессы:** Ищет процессы из списка `TargetProcesses` в `config.ini` (по умолчанию: `WhatsApp.exe`, `Telegram.exe`, `Viber.exe`).
- **RDP-сессия:** Проверяет, что найденный процесс запущен в той же RDP-сессии, что и сам агент. Это ключевая функция для многопользовательских серверов — каждый пользователь записывает только свои звонки.

### 2. Обнаружение звонка (START)

Логика старта записи отличается для разных приложений:

**Для Telegram:**
- **Двойная проверка:** Запись начинается, только если выполнены **оба** условия:
  1. **Наличие окна звонка:** `IsTelegramInCall()` проверяет, есть ли у процесса Telegram видимое окно, заголовок которого **не** начинается со слова "Telegram". Во время звонка Telegram создает отдельное окно с именем контакта в заголовке.
  2. **Наличие аудиопотока:** `GetProcessPeakLevel()` через WASAPI (`IAudioMeterInformation`) проверяет, что приложение действительно выводит звук (пиковый уровень выше `AUDIO_PEAK_THRESHOLD`).
- **Защита от уведомлений:** Эта комбинация предотвращает старт записи от коротких звуков уведомлений, так как для них не создается отдельное окно звонка.

**Для WhatsApp, Viber и других:**
- **Проверка аудиопотока:** Запись начинается, если `GetProcessPeakLevel()` показывает наличие звука несколько циклов подряд (`startThreshold` в `config.ini`).
- **Состояние сессии:** Дополнительно проверяется, что аудио-сессия процесса находится в состоянии `Active`.

### 3. Процесс записи

- **Захват аудио:** Используется библиотека [AudioCapture](https://github.com/masonasons/AudioCapture).
- **Два потока:**
  1. **Голос собеседника:** Захватывается аудиопоток конкретного приложения (WhatsApp, Telegram и т.д.).
  2. **Ваш голос:** Захватывается звук с микрофона по умолчанию в системе.
- **Микширование:** Оба потока смешиваются в реальном времени.
- **Кодирование:** Результат кодируется в MP3 (или WAV) с помощью LAME (или пишется как есть).
- **Умное именование:** Файл сохраняется в формате `{Дата}_{ПолноеИмя}_{Приложение}_{Время}.mp3`. Полное имя берется из профиля пользователя Windows.

### 4. Остановка записи (STOP)

Логика остановки также адаптирована под приложения:

**Для Telegram:**
- **Два сигнала (любой из них):**
  1. **Окно звонка закрыто:** `IsTelegramInCall()` возвращает `false`.
  2. **Аудио-сессия неактивна:** `IsSessionActive()` возвращает `false`. Это ключевой фикс: после завершения звонка в Telegram окно чата остается открытым, но аудио-сессия становится `Inactive`. Агент видит это и останавливает запись.

**Для WhatsApp, Viber и других:**
- **Основной сигнал:** `IsSessionActive()` возвращает `false`. Windows сообщает, что приложение перестало выводить звук.
- **Запасной механизм:** Если сессия по какой-то причине остается `Active`, но звука нет (пиковый уровень `0.0`), включается счетчик тишины `silenceThreshold`. После нескольких циклов тишины запись принудительно останавливается.

### 5. Автообновление

- **Проверка:** Каждые 6 часов (настраивается) агент отправляет запрос к GitHub API, чтобы получить информацию о последнем релизе.
- **Сравнение версий:** Сравнивает номер текущей версии (`APP_VERSION`) с версией из релиза.
- **Загрузка и установка:** Если доступна новая версия, агент скачивает `.exe` установщик, создает `.bat` скрипт-помощник и запускает его. Скрипт ждет завершения текущего процесса, запускает установщик в тихом режиме, перезапускает приложение и самоудаляется.

## Roadmap (План разработки)

| Функция | Статус | Приоритет | Описание |
|---|---|---|---|
| **Поддержка Skype** | Планируется | Высокий | Добавить `Skype.exe` в список процессов и адаптировать логику детекции. |
| **Веб-интерфейс** | Планируется | Средний | Создать локальный веб-сервер для просмотра логов и записей через браузер. |
| **Распознавание речи** | Идея | Низкий | Добавить опцию автоматической транскрибации звонков в текст (через OpenAI Whisper или другую модель). |
| **Централизованное хранилище** | Идея | Низкий | Возможность загрузки записей на центральный FTP или в облачное хранилище (S3). |
| **Улучшенная диагностика** | В процессе | Средний | Добавить больше информации в лог и на панель статуса для упрощения отладки. |
| **Рефакторинг кода** | В процессе | Высокий | Разделение монолитных файлов (MonitorThread, main) на более мелкие классы. |

## Установка

1. Скачайте `RDPCallRecorder_Setup.exe` со страницы [Релизы](../../releases).
2. **Запустите установщик от имени обычного пользователя** (права администратора НЕ нужны!).
3. Программа установится в `%LOCALAPPDATA%\RDPCallRecorder\`.
4. На рабочем столе появится ярлык — кликните для открытия настроек.
5. Выберите папку для записей и нажмите "Сохранить".

## Сборка из исходников

1. **Установите зависимости:** Visual Studio 2022 (C++), CMake, NSIS.
2. **Клонируйте репозитории:**
   ```cmd
   git clone https://github.com/masonasons/AudioCapture.git
   git clone https://github.com/vaildavis917-cell/RDPCallRecorder.git
   ```
3. **Запустите `build.bat`:**
   ```cmd
   cd RDPCallRecorder
   build.bat
   ```
   Для полной пересборки: `build.bat clean`
